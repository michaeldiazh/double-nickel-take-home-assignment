import {z} from 'zod';
import {LLMEvaluationAudit, SimplifiedLlmEvaluationAudit} from './domain';
import {KeyTranslator} from '../../services/filters/where-filter';
import {SimplifiedConversationRequirements} from '../conversation-requirements/domain';

/**
 * Simplified LLM evaluation audit row shape - base fields in snake_case (includes id, excludes timestamps)
 * Database row equivalent of SimplifiedLlmEvaluationAudit
 */
export const simplifiedLlmEvaluationAuditRowShape = {
    id: z.uuidv4(),
    conversation_requirement_id: z.uuidv4(),
    requirement_type: z.string().max(50),
    llm_value: z.record(z.string(), z.unknown()),
    llm_assessment_result: z.string().max(10).nullable(),
    confidence: z.number().min(0).max(1).nullable(),
    criteria: z.record(z.string(), z.unknown()),
    actual_result: z.string().max(10),
    model_name: z.string().max(50),
    discrepancy: z.boolean(),
};

/**
 * Simplified LLM evaluation audit row schema (snake_case, includes id, excludes timestamps)
 * Database row equivalent of SimplifiedLlmEvaluationAudit
 */
export const simplifiedLlmEvaluationAuditRowSchema = z.object(simplifiedLlmEvaluationAuditRowShape);

export type SimplifiedLlmEvaluationAuditRow = z.infer<typeof simplifiedLlmEvaluationAuditRowSchema>;

/**
 * Database row schema for llm_evaluation_audit table (snake_case)
 * Used for validating data coming from the database
 */
export const llmEvaluationAuditRowSchema = simplifiedLlmEvaluationAuditRowSchema.extend({
    created_at: z.date(),
    updated_at: z.date(),
});

export type LLMEvaluationAuditRow = z.infer<typeof llmEvaluationAuditRowSchema>;

/**
 * Key translator for SimplifiedConversationRequirements
 * Used when embedding conversation requirements in other entities
 */
const simplifiedConversationRequirementsDomainKeyToTableKey: KeyTranslator<SimplifiedConversationRequirements> = {
    id: 'id',
    conversationId: 'conversation_id',
    requirementId: 'requirement_id',
    messageId: 'message_id',
    status: 'status',
    value: 'value' as any,
};

export const llmEvaluationAuditDomainKeyToTableKey: KeyTranslator<LLMEvaluationAudit> = {
    id: 'id',
    requirementType: 'requirement_type',
    llmValue: 'llm_value' as any,
    llmAssessmentResult: 'llm_assessment_result',
    confidence: 'confidence',
    criteria: 'criteria' as any,
    actualResult: 'actual_result',
    modelName: 'model_name',
    discrepancy: 'discrepancy',
    conversationRequirement: simplifiedConversationRequirementsDomainKeyToTableKey,
    createdAt: 'created_at',
    updatedAt: 'updated_at',
};

export const simplifiedLlmEvaluationAuditDomainKeyToTableKey: KeyTranslator<SimplifiedLlmEvaluationAudit> = {
    id: 'id',
    conversationRequirementId: 'conversation_requirement_id',
    requirementType: 'requirement_type',
    llmValue: 'llm_value' as any,
    llmAssessmentResult: 'llm_assessment_result',
    confidence: 'confidence',
    criteria: 'criteria' as any,
    actualResult: 'actual_result',
    modelName: 'model_name',
    discrepancy: 'discrepancy',
};

/**
 * Database row schema for inserting a new LLM evaluation audit (snake_case)
 * Excludes id and timestamps which are generated by the database
 */
export const insertLlmEvaluationAuditRowSchema = z.object({
    conversation_requirement_id: z.uuidv4(),
    requirement_type: z.string().max(50),
    llm_value: z.record(z.string(), z.unknown()),
    llm_assessment_result: z.string().max(10).nullable(),
    confidence: z.number().min(0).max(1).nullable(),
    criteria: z.record(z.string(), z.unknown()),
    actual_result: z.string().max(10),
    model_name: z.string().max(50),
    discrepancy: z.boolean(),
});

export type InsertLlmEvaluationAuditRow = z.infer<typeof insertLlmEvaluationAuditRowSchema>;

